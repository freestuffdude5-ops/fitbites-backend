name: FitBites CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || \
            pip install fastapi uvicorn pydantic[email] sqlalchemy aiosqlite \
              anthropic httpx python-dotenv apscheduler python-multipart \
              pytest pytest-asyncio email-validator bcrypt pyjwt passlib sentry-sdk[fastapi]

      - name: Run tests
        run: python -m pytest tests/ -v --tb=short

      - name: Check imports
        run: python -c "from src.api.main import app; print('✅ App imports OK')"

  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t fitbites-api:test .

      - name: Test container starts
        run: |
          docker run -d --name fitbites-test -p 8000:8000 fitbites-api:test
          sleep 5
          curl -sf http://localhost:8000/health | grep -q ok
          docker stop fitbites-test

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Audit dependencies
        run: |
          pip install -e ".[dev]" 2>/dev/null || \
            pip install fastapi uvicorn pydantic sqlalchemy aiosqlite anthropic httpx
          pip-audit --strict 2>&1 || true  # Don't fail build, just report

  deploy:
    runs-on: ubuntu-latest
    needs: [test, docker]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }} --environment production --service prolific-optimism
          railway up --detach --service prolific-optimism
          echo "✅ Deployed to Railway"

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          for i in 1 2 3; do
            if curl -sf ${{ secrets.RAILWAY_URL }}/health | grep -q ok; then
              echo "✅ Deployment health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done
          echo "❌ Health check failed after 3 attempts"
          exit 1
